<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zone Leader Dashboard - NTPC Safety Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7fa; }
        .card { border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .table { border-radius: 8px; overflow: hidden; }
        .btn-sm { font-size: 0.8rem; }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <%- include('../partials/navbar') %>
    <div class="container my-5">
        <div class="card p-4">
            <h1 class="card-title text-center mb-4">Welcome, <%= user.name %> (Zone Leader)</h1>
            <% if (successMessage) { %>
                <div class="alert alert-success"><%= successMessage %></div>
            <% } %>
            <% if (errorMessage) { %>
                <div class="alert alert-danger"><%= errorMessage %></div>
            <% } %>
            <a href="/" class="btn btn-primary mb-4">Record New Observation</a>
            <h2 class="h4 mb-3">Open Observations in Your Zone</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Timestamps</th>
                            <th>Comments</th>
                            <th>Submissions</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% observations.forEach(obs => { %>
                            <tr>
                                <td><%= obs.description %></td>
                                <td>
                                    <span class="badge bg-<%= obs.status === 'pending' ? 'warning' : obs.status === 'approved' ? 'success' : obs.status === 'rejected' ? 'danger' : obs.status === 'forwarded' ? 'info' : 'secondary' %>">
                                        <%= obs.status %>
                                    </span>
                                    <% if (obs.forwardedBy) { %>
                                        <p class="small text-muted">Forwarded by <%= obs.forwardedBy %></p>
                                    <% } %>
                                </td>
                                <td>
                                    <p class="small">Raised: <%= obs.createdAt.toLocaleString() %></p>
                                    <% if (obs.forwardedAt) { %>
                                        <p class="small">Forwarded: <%= obs.forwardedAt.toLocaleString() %></p>
                                    <% } %>
                                    <% if (obs.closedAt) { %>
                                        <p class="small">Closed: <%= obs.closedAt.toLocaleString() %></p>
                                    <% } %>
                                </td>
                                <td>
                                    <% obs.comments.forEach(comment => { %>
                                        <p class="small"><strong><%= comment.userId.name %>:</strong> <%= comment.comment %> (<%= comment.createdAt.toLocaleString() %>)</p>
                                    <% }) %>
                                    <form action="/comment" method="POST">
                                        <input type="hidden" name="observationId" value="<%= obs._id %>">
                                        <textarea name="comment" class="form-control mb-2" placeholder="Add a comment" required></textarea>
                                        <button type="submit" class="btn btn-sm btn-primary">Comment</button>
                                    </form>
                                </td>
                                <td>
                                    <% if (obs.submissions && obs.submissions.length > 0) { %>
                                        <% obs.submissions.forEach(sub => { %>
                                            <p class="small"><strong><%= sub.vendorId.name %>:</strong> <%= sub.description %> (<%= sub.createdAt.toLocaleString() %>)
                                                <% if (sub.fileUrl) { %>
                                                    <a href="<%= sub.fileUrl %>" target="_blank">View File</a>
                                                <% } %>
                                            </p>
                                        <% }) %>
                                    <% } else { %>
                                        <p class="small text-muted">No submissions</p>
                                    <% } %>
                                </td>
                                <td>
                                    <a href="/observation/edit/<%= obs._id %>" class="btn btn-sm btn-warning">Edit</a>
                                    <form action="/observation/delete/<%= obs._id %>" method="POST" class="d-inline">
                                        <button type="submit" onclick="return confirm('Are you sure you want to delete this observation?')" class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                    <% if (obs.status === 'pending' || obs.status === 'approved') { %>
                                        <form action="/forward" method="POST" class="mt-2">
                                            <input type="hidden" name="observationId" value="<%= obs._id %>">
                                            <select name="vendorId" class="form-select form-select-sm mb-2" required>
                                                <option value="">Select Vendor</option>
                                                <% vendors.forEach(vendor => { %>
                                                    <option value="<%= vendor._id %>"><%= vendor.name %></option>
                                                <% }) %>
                                            </select>
                                            <button type="submit" class="btn btn-sm btn-info">Forward to Vendor</button>
                                        </form>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
            <h2 class="h4 mt-5 mb-3">Past Closed Observations</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Description</th>
                            <th>Closed At</th>
                            <th>Comments</th>
                            <th>Submissions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% closedObservations.forEach(obs => { %>
                            <tr>
                                <td><%= obs.description %></td>
                                <td><%= obs.closedAt ? obs.closedAt.toLocaleString() : 'N/A' %></td>
                                <td>
                                    <% obs.comments.forEach(comment => { %>
                                        <p class="small"><strong><%= comment.userId.name %>:</strong> <%= comment.comment %> (<%= comment.createdAt.toLocaleString() %>)</p>
                                    <% }) %>
                                </td>
                                <td>
                                    <% if (obs.submissions && obs.submissions.length > 0) { %>
                                        <% obs.submissions.forEach(sub => { %>
                                            <p class="small"><strong><%= sub.vendorId.name %>:</strong> <%= sub.description %> (<%= sub.createdAt.toLocaleString() %>)
                                                <% if (sub.fileUrl) { %>
                                                    <a href="<%= sub.fileUrl %>" target="_blank">View File</a>
                                                <% } %>
                                            </p>
                                        <% }) %>
                                    <% } else { %>
                                        <p class="small text-muted">No submissions</p>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <%- include('../partials/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>